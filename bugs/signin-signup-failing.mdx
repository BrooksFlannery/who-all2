# Authentication Sign-In/Sign-Up Failure Bug Report

## Issue Summary
Users are unable to sign in or sign up due to a database connection error in the Better Auth Drizzle adapter. The error occurs when the authentication system tries to query the database but encounters an undefined database object.

## Error Details

### Primary Error
```
TypeError: Cannot read properties of undefined (reading 'select')
```

### Error Location
- **File**: `node_modules/better-auth/dist/adapters/drizzle-adapter/index.mjs:181:30`
- **Function**: `findOne` method in Drizzle adapter
- **Context**: User authentication operations (findSession, findUserByEmail)

### Stack Trace
```
at Object.findOne (/Users/brooksflannery/Documents/GitHub/who-all2/node_modules/better-auth/dist/adapters/drizzle-adapter/index.mjs:181:30)
at Object.findOne (/Users/brooksflannery/Documents/GitHub/who-all2/node_modules/better-auth/dist/shared/better-auth.DFIAchwv.mjs:544:41)
at Object.findSession (/Users/brooksflannery/Documents/GitHub/who-all2/node_modules/better-auth/dist/shared/better-auth.BGG5f0S_.mjs:347:37)
```

## Root Cause Analysis

### 1. Database Initialization Pattern Mismatch
The database object (`db`) is undefined when passed to the Better Auth Drizzle adapter. This occurs because:

- Recent changes to the database initialization pattern introduced `initializeDatabase()` function
- The `lib/auth.ts` file was not updated to use the new pattern and still imports `db` directly
- Better Auth expects a database instance immediately, but receives `undefined`

### 2. Environment Variable Configuration
The app is configured to use both `EXPO_PUBLIC_DATABASE_URL` and `DATABASE_URL` environment variables, but there may be a mismatch or missing configuration.

### 3. Web Output Configuration
The app is configured with `web.output: "static"` in `app.config.js`, but API routes require `web.output: "server"` for proper server-side functionality.

## Affected Components

### Files Involved
- `lib/auth.ts` - Better Auth configuration
- `lib/db/index.ts` - Database initialization
- `app/api/auth/[...all]+api.ts` - Auth API routes
- `app.config.js` - Expo configuration

### Authentication Operations Affected
- User sign-in
- User sign-up
- Session management
- User lookup by email

## Impact
- **Severity**: High - Complete authentication system failure
- **Scope**: All authentication-related functionality
- **User Experience**: Users cannot access the application

## Steps to Reproduce

1. Start the Expo development server
2. Navigate to the sign-in or sign-up screen
3. Attempt to authenticate with valid credentials
4. Observe the server error in the console

## Environment Information
- **Platform**: Web (Expo Go)
- **Framework**: Expo Router
- **Database**: Neon PostgreSQL with Drizzle ORM
- **Authentication**: Better Auth with Drizzle adapter

## Proposed Solutions

### Immediate Fixes

1. **Fix Database Initialization in Auth Configuration**
   - Update `lib/auth.ts` to use `initializeDatabase()` instead of importing `db` directly
   - Ensure database is properly initialized before Better Auth configuration

2. **Update Web Configuration**
   - Change `web.output` from `"static"` to `"server"` in `app.config.js`
   - This is required for API routes to function properly

3. **Environment Variable Validation**
   - Add runtime checks for required environment variables
   - Provide clear error messages when configuration is missing

### Code Changes Required

1. **Update `app.config.js`**:
   ```javascript
   web: {
       bundler: "metro",
       output: "server", // Change from "static" to "server"
       favicon: "./assets/images/favicon.png",
   },
   ```

2. **Fix Auth Database Initialization**:
   ```typescript
   // In lib/auth.ts
   import { initializeDatabase } from "./db";
   
   const db = initializeDatabase();
   if (!db) {
       throw new Error("Failed to initialize database for authentication");
   }
   
   export const auth = betterAuth({
       database: drizzleAdapter(db, {
           provider: "pg",
           schema
       }),
       // ... rest of config
   });
   ```

3. **Add Auth Error Handling**:
   - Implement proper error responses for database connection failures
   - Add user-friendly error messages

## Testing Recommendations

1. **Environment Testing**
   - Verify `DATABASE_URL` is properly set
   - Test database connectivity independently

2. **Authentication Flow Testing**
   - Test sign-in with valid credentials
   - Test sign-up with new user
   - Test session persistence

3. **Error Handling Testing**
   - Test behavior when database is unavailable
   - Verify error messages are user-friendly

## Related Issues
- API routes not functioning due to static web output configuration
- Database connection may be failing silently
- Environment variable validation may be insufficient

## Notes
- The error suggests the database object is undefined, indicating a configuration or initialization issue
- The Better Auth library expects a properly configured Drizzle database instance
- This appears to be a server-side configuration issue rather than a client-side problem

## Status
- **Status**: Resolved (All major issues fixed)
- **Priority**: High
- **Assigned**: TBD
- **Created**: [Current Date]
- **Last Updated**: [Current Date]

## Resolution Steps Completed
1. âœ… Identified root cause: Database initialization pattern mismatch
2. âœ… Updated `lib/auth.ts` to use `initializeDatabase()` pattern
3. âœ… Added proper error handling for database initialization failure
4. âœ… Updated `app.config.js` web output from "static" to "server"
5. âœ… Fixed all API routes to use `initializeDatabase()` pattern:
   - `app/api/events/+api.ts`
   - `app/api/events/recommended/+api.ts`
   - `app/api/chat/[...all]+api.ts`
   - `app/api/chat/summarize/+api.ts`
6. âœ… Updated all test files to use `initializeDatabase()` pattern:
   - `tests/test-event-recommendations.test.ts`
   - `tests/test-recommended-events.test.ts`
   - `tests/test-interest-schemas.test.ts`
   - `tests/test-chat-summarization.test.ts`
7. âœ… **Fixed Event Embeddings Issue**:
   - Created `scripts/generate-event-embeddings.ts` script
   - Added `npm run generate:event-embeddings` to package.json
   - Generated embeddings for all 6 existing events
   - Added automatic embedding generation to event creation pipeline in `lib/db/events.ts`

## Remaining Tasks
1. ðŸ”„ Test authentication flow after changes
2. ðŸ”„ Test compare events button functionality
3. ðŸ”„ Verify environment variables are properly configured
4. ðŸ”„ Run full test suite to ensure all fixes work correctly
