# Bug Report: Mobile Authentication Session Issues

## üêõ Problem Description

**Title**: Mobile devices experience 404/401 errors after successful login while web works correctly

**Severity**: High - Blocks mobile app functionality

**Environment**: 
- ‚úÖ Web (Mac): Authentication works correctly
- ‚ùå Mobile (Samsung Android): Authentication fails after login

## üìã Symptoms

### Web (Working)
- Login successful
- Session properly established
- API calls return 200 status
- Events and chat load correctly

### Mobile (Broken)
- Login appears successful initially
- Session found in client logs
- API calls return 404/401 status
- Events fail to load with "Unauthorized" error
- Chat screen loads but messages don't appear

## üîç Root Cause Analysis

Based on the logs and code analysis, the issue stems from multiple interconnected problems:

### 1. Missing BETTER_AUTH_SECRET
- **Impact**: Better Auth requires a secret for session encryption/signing
- **Evidence**: Mobile builds can't find the secret, causing session validation to fail
- **Status**: ‚úÖ **RESOLVED** - Secret has been added to .env

### 2. Base URL Configuration Mismatch
- **Impact**: Different base URLs between web and mobile cause session cookie/header issues
- **Evidence**: 
  - Web: `baseURL: ""` (defaults to localhost:8081)
  - Mobile: `baseURL: "https://idlbcxe-anonymous-8081.exp.direct"`
- **Status**: ‚ö†Ô∏è **NEEDS ATTENTION**

### 3. Session Storage Inconsistency
- **Impact**: Better Auth expects consistent cookie/session_token handling
- **Evidence**: Mobile sends Authorization headers but server expects cookies
- **Status**: ‚ö†Ô∏è **NEEDS ATTENTION**

### 4. Cookie Handling Issues
- **Impact**: Known bug in @better-auth/expo with cookie expiry parsing
- **Evidence**: "session found" then suddenly "Auth handler status: 404"
- **Status**: ‚ö†Ô∏è **NEEDS ATTENTION**

## üõ†Ô∏è Resolution Steps

### Step 1: Verify BETTER_AUTH_SECRET ‚úÖ
```bash
# Confirm secret is properly set in .env
echo $BETTER_AUTH_SECRET
```

### Step 2: Fix Base URL Configuration
**File**: `lib/auth-client.ts`

**Current Issue**: Hardcoded tunnel URL that may change
```typescript
// Current problematic code
return "https://idlbcxe-anonymous-8081.exp.direct";
```

**Solution**: Use dynamic URL detection
```typescript
const getBaseURL = () => {
    if (Platform.OS === "web") {
        return "";
    }
    // Use environment variable or detect dynamically
    return process.env.EXPO_PUBLIC_API_URL || "https://idlbcxe-anonymous-8081.exp.direct";
};
```

### Step 3: Update Better Auth Configuration
**File**: `lib/auth.ts`

**Add missing configuration**:
```typescript
export const auth = betterAuth({
    // ... existing config ...
    secret: process.env.BETTER_AUTH_SECRET, // Add this line
    // ... rest of config ...
});
```

### Step 4: Fix Session Handling in API Routes
**File**: `app/api/events/+api.ts`

**Current Issue**: Inconsistent session validation
**Solution**: Use consistent auth.api.getSession approach

### Step 5: Update @better-auth/expo Package
**Current Version**: 1.2.12
**Check for updates**:
```bash
npm outdated @better-auth/expo
npm update @better-auth/expo
```

### Step 6: Test Authentication Flow
1. Clear all app data/cache
2. Restart development server
3. Test login on mobile device
4. Verify session persistence across app restarts

### Step 7: Add Environment Variables
**File**: `.env`
```bash
BETTER_AUTH_SECRET=your_generated_secret_here
EXPO_PUBLIC_API_URL=https://your-tunnel-url.exp.direct
```

### Step 8: Verify Cookie Handling
**File**: `lib/auth-client.ts`

**Ensure proper cookie handling**:
```typescript
// In getAuthHeaders function
if (session.data?.session?.token) {
    headers['Authorization'] = `Bearer ${session.data.session.token}`;
    // Use proper Better Auth cookie format
    headers['Cookie'] = `better-auth.session_token=${session.data.session.token}`;
}
```

## üß™ Testing Checklist

- [ ] Web authentication still works
- [ ] Mobile authentication works after login
- [ ] Session persists across app restarts
- [ ] API calls return 200 status on mobile
- [ ] Events load correctly on mobile
- [ ] Chat messages load correctly on mobile
- [ ] No 404/401 errors in mobile logs

## üìù Additional Notes

- The issue appears to be primarily related to Better Auth configuration and session handling
- Previous similar issues were caused by tunnel setup and IP address mismatches
- The missing BETTER_AUTH_SECRET was likely the primary cause
- Mobile-specific cookie handling in Better Auth may require additional configuration

## üîó Related Files

- `lib/auth-client.ts` - Auth client configuration
- `lib/auth.ts` - Better Auth server configuration  
- `app/api/events/+api.ts` - Events API with session validation
- `components/AuthProvider.tsx` - Auth context provider
- `.env` - Environment variables

## üìä Current Status

- **BETTER_AUTH_SECRET**: ‚úÖ Added
- **Base URL Configuration**: ‚ö†Ô∏è Needs update
- **Session Handling**: ‚ö†Ô∏è Needs review
- **Package Updates**: ‚ö†Ô∏è Check for updates
- **Testing**: ‚ùå Pending

**Next Action**: Complete Steps 2-8 above and test the authentication flow.